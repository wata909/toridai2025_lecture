<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rotate the World デモ</title>
  <style>
    body { margin: 0; background: #000; overflow: hidden; }
    canvas { cursor: move; display: block; }
    path.sphere { fill: #000; }
    path.land { fill: #7f7; }
    path.graticule { fill: none; stroke: #777; stroke-width: .5px; stroke-opacity: .5; }
    footer { position: absolute; bottom: 5px; left: 5px; color: #fff; font-size: 12px; }
    footer a { color: #0bf; text-decoration: none; }
  </style>
</head>
<body>
  <script src="d3.min.js"></script>
  <script src="d3.geo.projection.min.js"></script>
  <script src="topojson.min.js"></script>
  <script src="app.min.js"></script>
  <script>
    // ビューポートサイズを取得
    var width = window.innerWidth, height = window.innerHeight;

    // Orthographic 投影の設定
    var projection = d3.geoOrthographic()
        .scale((Math.min(width, height) / 2) - 10)
        .translate([width / 2, height / 2])
        .clipAngle(90);

    var canvas = d3.select("body").append("canvas")
        .attr("width", width)
        .attr("height", height)
        .node();
    var context = canvas.getContext("2d");
    var path = d3.geoPath()
        .projection(projection)
        .context(context);

    // 球体と経緯線
    var sphere = {type: "Sphere"};
    var graticule = d3.geoGraticule();

    // 描画関数
    function render() {
      context.clearRect(0, 0, width, height);
      context.beginPath(); path(sphere); context.fillStyle = '#000'; context.fill();
      context.beginPath(); path(graticule()); context.strokeStyle = '#777'; context.lineWidth = 0.5; context.stroke();
      context.beginPath(); path(land); context.fillStyle = '#7f7'; context.fill();
    }

    // 地理データ読み込み
    var land;
    d3.json('world-110m.json').then(function(world) {
      land = topojson.feature(world, world.objects.land);
      render();
    });

    // ドラッグによる回転有効化
    d3.geoZoom().projection(projection).on('zoom', render)(canvas);

    // リサイズ対応
    window.addEventListener('resize', function() {
      width = window.innerWidth; height = window.innerHeight;
      projection.translate([width/2, height/2]);
      canvas.width = width; canvas.height = height;
      render();
    });
  </script>
  <footer>出典：<a href="https://www.jasondavies.com/maps/rotate/" target="_blank">Jason Davies : Maps : Rotate the World</a></footer>
</body>
</html>
